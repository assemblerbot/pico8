title_image=[[ ã­ ã†ã“'''ã­ã­=ã­6ã²â—ã‚»1ã‚‰&ã­ãµã‚ƒ'3ã‚5ã‚Œ2)109(â—ã‚‹3ãµ5ã®&1ã¿2#3(6ã‚ªâ—ã‚„5ã²ã¾6.5ã‚·5,â—ã‚‚=*â—â—â—ã‚Œ&ã¯2#3(ã®&â—ã£1ã‚2"6)72ãŸã‚ãŸã‚3ãƒ§2$e2@_7q:svã¦9ã‚(6 7ã‚„>2@_8q9srã‚<âœ½'ã‚Š>2^_ãƒ³5ã‚ƒ5ã‚Š3ã‚«722"^/bsâ–ˆã‚7-ã‚‹bmes6 7ã—b0ã‚‚âˆ§ã‚3ãƒ§?â`08ã„ãƒ²''ã‚ª:^=ãƒŠğŸ…¾ï¸ã‚4ãƒ£5ã‚Š6ã‚„2 h^^âœ½6â—‹2y9ãƒ©6/ã‚„?ã‚@ãƒ›i^@ã‚3ãƒ¥6$6ã‚±8/:ãƒ©5`2ãƒğŸ±ã‚ãƒ¬`â–‘1ã¸4 ã‚¤')2 1ãƒª5'824z^/9s?q@â–‘4$2ã‚@ã™ãµ*ã»4'ã¸136ã™@/9`2x*ã»=â–‘1ãƒ¥3â–‘4#ã»*ã»2'6â–¤aãƒª;ã‚;/`sc02ã‚Šb^ã¸*1ãƒ«1â—œ6'ãµ23ã‚‚</:`7h?â–‘m^4ã1ã‚4ãƒª3'42=ã‚</:`7h?â–‘2ãƒ¨4Ë‡4'2ãƒ„1ã3ãƒ„3'ã¾3ãƒ¥'7ãƒŒ8ãƒã¿=/:`7h?â–‘5ğŸ±'e^:ã‚„5ã‚Šâ–‘ã‚dâ–‘4ã‚=^9ã‚1ã¤*1â—œ2#5ã‚¨101/;@;/:`9hbâ–‘4â–¤7ã‚¤=ã3ãƒ¬6 ;0:ãŸ=/:`9uaâ–‘:â?0ã¯]]
car_image=[[ ã­ ã­ã“â—â—â—â—â—â—â—ãƒ¢+r ã•ã¿#d!4"6?'ã‹ã‚€##!b 1ã‚++9<+ã„ã‚„gã¿'ãµ<ã‚·1ã‚„âˆ§ã‚†gã‚€2ã‚1ã¤>ã‚»+%%â¬†ï¸ã‚„1ã‚dã‚€3ã‚#ã‚‹âˆ§ã‚„hã‚€2ã‚ã¯@ãƒ+â˜…ã‚„+hã‚3ã‚µ#+ã‚Œ!ã¯ğŸ…¾ï¸ã‚„iã‚1 2ã™_ã‚ãµ%'âŒ‚ã‚†+#fã‚2ã‚†1ã‚»#ã‚“3ã‚„%â™¥ã‚„++iã‚€3ã‚1ã—`ãƒˆã® âŒ‚ã‚„qã‚#ã‚“!ã®ì›ƒã‚„+#oã‚!cã‚181ãµâ–‘ã‚„+lã‚3ã‚»#+ã‚¦~ã‚„1ğŸ…¾ï¸a"#^!36v â–’ã¸_ã‚“'+''4ã»_ã‚±c3fã‚„iã¦:â–ˆ1ã®''6ã‚’d `:ã‚ƒ4ã‘;â—5"7âœ½4+3ã‚€7ã‚±{ ã£'%u ''ã¸7ã‚³ãƒ©!y %ã¸â–ˆ ã‚’%''!%eãƒ©%!%%+'5 ãµxã¿:ãƒŸã‚“$$ã¯!a ãµ+1_4!ã²>â˜…ã¿2>$4ã­<ã‚6ã‚†ã‚“''ã‚…!ãµ&'4 1ãƒŒ%9â¡ï¸^ã‚†=ã‚ª1ãƒ3â–’ã‚…1ğŸ…¾ï¸1ãƒ«ã‚¦2Ë‡2!!ã¯:ã‚ã‚Š>ã‚¢5ã‚6ã‚„ã‚%''!%ã‚%3#ã²%+'3 #ã®1ã£2ã‚3â—†mã‚„6ã‚1ã‚„ã‚…$$4ã‚2ã¦@ã‚‹ã²#$5 2+4ã‚€5â˜…bã‚„5ã‚±>fã‚’''1ãŠ?ã¾2ã‚…2ã‚¦ã²+'5 1ãƒ‹:ã‚1ã‚½ã‚’6ã‚Œ9gã‚…$$ã²6ã¦6ã²7ãƒ¬ã¯$5 2ã‚¯;ã‚ã®hã‚„>ãƒ’ã‚’''ã²:ã‚€:!#16'5 1b+ã‚†3â§—^ãµ4ã‚2ãƒ²!%%2Ë‡3ãƒ’ã‚’$1ã»dâ—#2ã‚µ:ã¦2ã‚$1 3â¡ï¸ã‚ˆ1ã‚»;"3ã¿%$4ã‚„1ãƒã‚x 2ã‚%3ã‚5ã‚†3ã«2ãµ4#<!!1ã‚„1ã‚€1!1r1ã‚“ã‚Œ1ãƒ„#!g!3ãƒ²7ã‚€1â—†1ã¾1â§—%2ã‚‹ã¾7$<ã‚Š+3d1â—ã‚¢9ã„`*3ãƒ£2ãª3,2!5ã‚¦35ã®8ã¤3ãµ#7#ã®5j&2tã¯&&ã‚’#h!6ãƒ„ã²:ã‚2ã‚·$%!=ã‚:ã‚Œ+3ãƒ›ã¾!''^ã‚ã®kã‚„ã»:ã‚'1â˜‰1â¡ï¸1ã‚ª1ã‚ƒ7ã¤? 4ãƒª&!$4ãƒƒ_ã‚€ã²1â—‹g ã¾%2â¬‡ï¸2ã«1ã¿ã®2ã‚Š1ã†$$!2ã‚6#ã®+9 4ãƒª%1a$ã®aã‚€2ã‚„4ã†#%2ã4ãª6$121ã‚½1ãƒ†2ãƒ‹6ã‚Œ1lã®$4ã‚2ã‚…;ã«+2ã‚‰5g6ãƒª2ã‚€ã‚‡ 7g5#5%1ã‚±819ğŸ˜%&!!1â—†$2ã‚Œ2ã‚¢3ãƒ¤;ã¬ã‚„1ãƒ«1ã‚„ã‚±1ãƒ˜3ã†:ã‚„5#:ã‚1ã²'ã®$1%6/h!%&2iã‚³9ãƒ¤7ã‚‹7,9<2ã‚†'1â€¦6ãƒ¦ã‚Š9â§—%!%1ã‚$%ã‚¿4ã_â¬†ï¸2ã‚±%&1ã¾$1"$''ã²5ã‚5ã­@â§—%&&$&&!ãƒf0ã¯1ã‚½1ã‚„!2ã¿3ã‚¢^ã»;ã‚„&!$2ãƒªãƒ 9ãƒã²'!%$'4ã‚„3ã‚ã‚¦%ã®1ã‚„bãƒŠeã‚„bãƒ%$&1ãµ$$2ã‚„&%3ã‚‡câã¾$&$%%fã‚ã‚cãƒŒ3ã¨!'1ã‚€5,ã‚…7ã‚„2 ãƒ©6ã‚„$%1ã¾1ã‚€'3â¬†ï¸ag<â¬†ï¸2cãƒˆeãƒã®$$&!&1â¡ï¸$ã¸pâ¬†ï¸gã‚_ã‚„fãƒ1ãµ$$2ã‚‹ã²iË‡rã‚@ã‚„hãƒ2ã‚„2"2ã‚lâˆ§r?oã‚8ãƒ1ã»â–¥ã‚<ã‚†oãƒ3ã‚€âˆ§ã‚ã‚ãƒã­:â—â—â—â—â—â—â—â—ãƒ¨]]

title_items={
	{l=function() player_color=player_color%#car_colors_default+1 end,r=function() player_color=(player_color+#car_colors_default-2)%#car_colors_default+1 end,un=function() pal(11,car_colors_default[player_color][1],1) pal(3,car_colors_default[player_color][2],1) return "car color" end},
	{l=function() difficulty=(difficulty+#difficulty_levels-2)%#difficulty_levels+1 end,r=function() difficulty=difficulty%#difficulty_levels+1 end,un=function() return difficulty_levels[difficulty].n end},
	{n="tournament",e=function() tour=split("0,0,0,0") track=1 waypoint_order=1 laps_count=4 cars_count=4 set_state(2) end},
	{n="single race",e=function() tour=nil menu_tracks() end}
}
title_sel=1

track_items={
	{n="track 1",e=function() track=1 menu_setup() end},
	{n="track 2",e=function() track=2 menu_setup() end},
	{n="track 3",e=function() track=3 menu_setup() end}
}
track_sel=1

setup_items={
	{l=function() laps_count=max(laps_count-1,1) end,r=function() laps_count=min(laps_count+1,20) end,un=function() return "laps "..laps_count end},
	{l=function() waypoint_order*=-1 end,r=function() waypoint_order*=-1 end,un=function() if waypoint_order==1 then return "reverse off" else return "reverse on" end end},
	{l=function() cars_count=max(cars_count-1,1) end,r=function() cars_count=min(cars_count+1,4) end,un=function() return "opponents "..(cars_count-1) end},
	{n="start!",e=function() set_state(2) end}
}
setup_sel=1

menu=nil
menu_get_sel=nil
menu_set_sel=nil
menu_enter=nil
menu_back=nil

function title_init()
	pal(split("0,8,2,13,5,6,7,9,132,4,8,129,1,140,12"),1)
	
	car_rendering_init()
	shadows_init("0,0,2,3,5,1,6,7,8,4,4,11,0,12,13,14")
	
	lz77_decomp(0,0,128,32,title_image,sset)
	lz77_decomp(0,32,128,64,car_image,sset)
	
	for y=0,4+8 do
		for x=0,15 do
			poke(0x2000 + x+y*128,x+y*16)
		end
	end
	
	menu_title()
	music(0)
end

function title_update()
	menu_update()
end

function title_draw()
	local center_x,center_y=64,45
	for i=0,127 do
		local f=(((i>>4)+time()*2)*4) & 7
		local c
		if f>3 then
			c=15-(f&3)
		else
			c=12+(f&3)
		end
		
		line(center_x,center_y,i,127,c)
		line(center_x,center_y,127-i,0,c)
		line(center_x,center_y,0,i,c)
		line(center_x,center_y,127,127-i,c)
	end
	
	map(0,0,0,4-4*abs(sin(time()*5)),16,4)
	map(0,4,0,32,16,8)
	
	if time()>2.5 then
		menu_draw(title_items,title_sel)
	else
		printo("by assembler bot (2021)",18,120,7)
	end
end


function menu_title()
	menu_init(title_items,function() return title_sel end, function(val) title_sel=val end, function() end)
end

function menu_tracks()
	menu_init(track_items,function() return track_sel end, function(val) track_sel=val end, function() menu_title() end)
end

function menu_setup()
	menu_init(setup_items,function() return setup_sel end, function(val) setup_sel=val end, function() menu_tracks() end)
end

function menu_init(items,get,set,back)
	menu=items
	menu_get_sel=get
	menu_set_sel=set
	menu_back=back
end

function menu_update()
	if btnp(0) then
		local left=menu[menu_get_sel()].l
		if left~=nil then sfx(50) left() end
	end
	
	if btnp(1) then
		local right=menu[menu_get_sel()].r
		if right~=nil then sfx(50) right() end
	end

	if btnp(2) then
		sfx(50)
		menu_set_sel(max(menu_get_sel()-1,1))
	end

	if btnp(3) then
		sfx(50)
		menu_set_sel(min(menu_get_sel()+1,#menu))
	end

	if btnp(4) then
		local enter=menu[menu_get_sel()].e
		if enter~=nil then sfx(51) enter() end
	end

	if btnp(5) then
		sfx(52)
		menu_back()
	end

	if game_state~=1 then return end
	for i=1,#menu do
		if menu[i].un~=nil then
			menu[i].n=menu[i].un()
		end
	end
end

function menu_draw()
	draw_shade(32,92,32,126,94,126,94,92)
	rect(32,92,96,126,0)

	for i=1,#menu do
		local x=(96+34-#menu[i].n*4)\2
		local y=(126+92-#menu*7)\2+(i-1)*8
		local nx=(96+34-#car_colors_default[player_color][3]*4)\2
		
		printo(car_colors_default[player_color][3],nx,85,11)
		
		if menu_get_sel()==i and menu[i].l~=nil then
			print("â¬…ï¸", 34, y, 2)
			print("â¡ï¸", 88, y, 2)
		end
		
		printo(menu[i].n, x, y, 7-5*is(menu_get_sel(),i))
	end
end

function is(x,y)
	if x==y then return 1 end
	return 0
end