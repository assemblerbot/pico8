title_image=[[ ね うこ'''ねね=ね6ひ◝セ1ら&ねふゃ'3わ5れ2)109(◝る3ふ5の&1み2#3(6オ◝や5ひま6.5シ5,◝も=*◝◝◝れ&は2#3(の&◝っ1わ2"6)72ためたあ3ョ2$e2@_7q:svて9め(6 7や>2@_8q9srめ<✽'り>2^_ン5ゃ5り3カ722"^/bs█め7-るbmes6 7しb0も∧め3ョ?❎`08いヲ''オ:^=ナ🅾️め4ャ5り6や2 h^^✽6○2y9ラ6/や?あ@ホi^@め3ュ6$6ケ8/:ラ5`2ネ🐱めレ`░1へ4 イ')2 1リ5'824z^/9s?q@░4$2め@すふ*ほ4'へ136す@/9`2x*ほ=░1ュ3░4#ほ*ほ2'6▤aリ;め;/`sc02りb^へ*1ル1◜6'ふ23も</:`7h?░m^4そ1め4リ3'42=め</:`7h?░2ヨ4ˇ4'2ツ1そ3ツ3'ま3ュ'7ヌ8ノみ=/:`7h?░5🐱'e^:や5り░めd░4あ=^9め1つ*1◜2#5エ101/;@;/:`9hb░4▤7イ=そ3レ6 ;0:た=/:`9ua░:❎?0は]]
car_image=[[ ね ねこ◝◝◝◝◝◝◝モ+r さみ#d!4"6?'かむ##!b 1め++9<+いやgみ'ふ<シ1や∧ゆgむ2め1つ>セ+%%⬆️や1めdむ3め#る∧やhむ2めは@チ+★や+hめ3サ#+れ!は🅾️やiめ1 2す_めふ%'⌂ゆ+#fめ2ゆ1セ#ん3や%♥や++iむ3め1し`トの ⌂やqめ#ん!の웃や+#oめ!cめ181ふ░や+lめ3セ#+ウ~や1🅾️a"#^!36v ▒へ_ん'+''4ほ_ケc3fやiて:█1の''6をd `:ゃ4け;◝5"7✽4+3む7ケ{ っ'%u ''へ7コラ!y %へ█ を%''!%eラ%!%%+'5 ふxみ:ミん$$は!a ふ+1_4!ひ>★み2>$4ね<め6ゆん''ゅ!ふ&'4 1ヌ%9➡️^ゆ=オ1ノ3▒ゅ1🅾️1ルウ2ˇ2!!は:めり>ア5め6やわ%''!%ろ%3#ひ%+'3 #の1っ2め3◆mや6め1やゅ$$4め2て@るひ#$5 2+4む5★bや5ケ>fを''1お?ま2ゅ2ウひ+'5 1ニ:め1ソを6れ9gゅ$$ひ6て6ひ7レは$5 2ク;めのhや>ヒを''ひ:む:!#16'5 1b+ゆ3⧗^ふ4め2ヲ!%%2ˇ3ヒを$1ほd◝#2サ:て2め$1 3➡️よ1セ;"3み%$4や1ハわx 2め%3め5ゆ3に2ふ4#<!!1や1む1!1r1んれ1ツ#!g!3ヲ7む1◆1ま1⧗%2るま7$<り+3d1◝ア9い`*3ャ2な3,2!5ウ35の8つ3ふ#7#の5j&2tは&&を#h!6ツひ:め2シ$%!=め:れ+3ホま!''^めのkやほ:め'1☉1➡️1オ1ゃ7つ? 4リ&!$4ッ_むひ1○g ま%2⬇️2に1みの2り1う$$!2め6#の+9 4リ%1a$のaむ2や4う#%2そ4な6$121ソ1テ2ニ6れ1lの$4め2ゅ;に+2ら5g6リ2むょ 7g5#5%1ケ819😐%&!!1◆$2れ2ア3ヤ;ぬや1ル1やケ1ヘ3う:や5#:め1ひ'の$1%6/h!%&2iコ9ヤ7る7,9<2ゆ'1…6ユり9⧗%!%1め$%タ4き_⬆️2ケ%&1ま$1"$''ひ5ろ5ね@⧗%&&$&&!チf0は1ソ1や!2み3ア^ほ;や&!$2リム9ネひ'!%$'4や3めウ%の1やbナeやbネ%$&1ふ$$2や&%3ょc❎ま$&$%%fめわcヌ3と!'1む5,ゅ7や2 ラ6や$%1ま1む'3⬆️ag<⬆️2cトeネの$$&!&1➡️$へp⬆️gめ_やfノ1ふ$$2るひiˇrめ@やhネ2や2"2めl∧r?oめ8ネ1ほ▥め<ゆoノ3む∧めあノね:◝◝◝◝◝◝◝◝ヨ]]

title_items={
	{l=function() player_color=player_color%#car_colors_default+1 end,r=function() player_color=(player_color+#car_colors_default-2)%#car_colors_default+1 end,un=function() pal(11,car_colors_default[player_color][1],1) pal(3,car_colors_default[player_color][2],1) return "car color" end},
	{l=function() difficulty=(difficulty+#difficulty_levels-2)%#difficulty_levels+1 end,r=function() difficulty=difficulty%#difficulty_levels+1 end,un=function() return difficulty_levels[difficulty].n end},
	{n="tournament",e=function() tour=split("0,0,0,0") track=1 waypoint_order=1 laps_count=4 cars_count=4 set_state(2) end},
	{n="single race",e=function() tour=nil menu_tracks() end}
}
title_sel=1

track_items={
	{n="track 1",e=function() track=1 menu_setup() end},
	{n="track 2",e=function() track=2 menu_setup() end},
	{n="track 3",e=function() track=3 menu_setup() end}
}
track_sel=1

setup_items={
	{l=function() laps_count=max(laps_count-1,1) end,r=function() laps_count=min(laps_count+1,20) end,un=function() return "laps "..laps_count end},
	{l=function() waypoint_order*=-1 end,r=function() waypoint_order*=-1 end,un=function() if waypoint_order==1 then return "reverse off" else return "reverse on" end end},
	{l=function() cars_count=max(cars_count-1,1) end,r=function() cars_count=min(cars_count+1,4) end,un=function() return "opponents "..(cars_count-1) end},
	{n="start!",e=function() set_state(2) end}
}
setup_sel=1

menu=nil
menu_get_sel=nil
menu_set_sel=nil
menu_enter=nil
menu_back=nil

function title_init()
	pal(split("0,8,2,13,5,6,7,9,132,4,8,129,1,140,12"),1)
	
	car_rendering_init()
	shadows_init("0,0,2,3,5,1,6,7,8,4,4,11,0,12,13,14")
	
	lz77_decomp(0,0,128,32,title_image,sset)
	lz77_decomp(0,32,128,64,car_image,sset)
	
	for y=0,4+8 do
		for x=0,15 do
			poke(0x2000 + x+y*128,x+y*16)
		end
	end
	
	menu_title()
	music(0)
end

function title_update()
	menu_update()
end

function title_draw()
	local center_x,center_y=64,45
	for i=0,127 do
		local f=(((i>>4)+time()*2)*4) & 7
		local c
		if f>3 then
			c=15-(f&3)
		else
			c=12+(f&3)
		end
		
		line(center_x,center_y,i,127,c)
		line(center_x,center_y,127-i,0,c)
		line(center_x,center_y,0,i,c)
		line(center_x,center_y,127,127-i,c)
	end
	
	map(0,0,0,4-4*abs(sin(time()*5)),16,4)
	map(0,4,0,32,16,8)
	
	if time()>2.5 then
		menu_draw(title_items,title_sel)
	else
		printo("by assembler bot (2021)",18,120,7)
	end
end


function menu_title()
	menu_init(title_items,function() return title_sel end, function(val) title_sel=val end, function() end)
end

function menu_tracks()
	menu_init(track_items,function() return track_sel end, function(val) track_sel=val end, function() menu_title() end)
end

function menu_setup()
	menu_init(setup_items,function() return setup_sel end, function(val) setup_sel=val end, function() menu_tracks() end)
end

function menu_init(items,get,set,back)
	menu=items
	menu_get_sel=get
	menu_set_sel=set
	menu_back=back
end

function menu_update()
	if btnp(0) then
		local left=menu[menu_get_sel()].l
		if left~=nil then sfx(50) left() end
	end
	
	if btnp(1) then
		local right=menu[menu_get_sel()].r
		if right~=nil then sfx(50) right() end
	end

	if btnp(2) then
		sfx(50)
		menu_set_sel(max(menu_get_sel()-1,1))
	end

	if btnp(3) then
		sfx(50)
		menu_set_sel(min(menu_get_sel()+1,#menu))
	end

	if btnp(4) then
		local enter=menu[menu_get_sel()].e
		if enter~=nil then sfx(51) enter() end
	end

	if btnp(5) then
		sfx(52)
		menu_back()
	end

	if game_state~=1 then return end
	for i=1,#menu do
		if menu[i].un~=nil then
			menu[i].n=menu[i].un()
		end
	end
end

function menu_draw()
	draw_shade(32,92,32,126,94,126,94,92)
	rect(32,92,96,126,0)

	for i=1,#menu do
		local x=(96+34-#menu[i].n*4)\2
		local y=(126+92-#menu*7)\2+(i-1)*8
		local nx=(96+34-#car_colors_default[player_color][3]*4)\2
		
		printo(car_colors_default[player_color][3],nx,85,11)
		
		if menu_get_sel()==i and menu[i].l~=nil then
			print("⬅️", 34, y, 2)
			print("➡️", 88, y, 2)
		end
		
		printo(menu[i].n, x, y, 7-5*is(menu_get_sel(),i))
	end
end

function is(x,y)
	if x==y then return 1 end
	return 0
end